<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>直播列表</title>
        <include file="./Home/Tpl/Index/include/head.html" />

		<!--<script src="js/ckplayer/ckplayer.js"></script>-->
    </head>
    
    
    <body>
 		
        <!--头部 start-->
    	<include file="./Home/Tpl/Index/include/header.html" />
        <!--头部   end-->
        
        
        <!--主内容  start-->
        <div class="main_content f_pr loading" data-type="live_broadcast_list_detail">
			<div class="main_contnet_inner f_pr ">
                
                <!--直播详情  start-->
                <div class="live_broadcast_list_detail_box"></div>
                <!--直播详情    end-->
                
				<!--文章列表  start-->
                <div class="live_broadcast_detail_list">
                	<ul></ul>
                    <div class="load_more_article f_tac ">加载更多...</div>
                </div>
                <!--文章列表    end-->
                
            </div>
        </div>
        <!--主内容    end-->
        
        <!--底部 start-->
        <include file="./Home/Tpl/Index/include/footer.html" />
        <!--底部   end-->
        
        
        
        <script src="js/jquery.min.1.8.3.js?v=1.7"></script>
        <script>
        	$(function(){
				
				//图片路径
				var imgRoute="./",
					pagenum=5,
					skipnum=0;
					//不同专栏数据请求
					$.ajax({
						url:golbalIp+"/main/live_detail",
						type:"get",
						dataType:"json",
						data:{"skipnum":0,"length":pagenum,"id":units.getUrlParam("id")!=null ? units.getUrlParam("id") : ""},
						beforeSend:function(){},
						success:function(data){
							//请求成功
							if(data.code==1){
								
								//直播详情
								var img=(data.data.img==null || data.data.img=="")  ? imgRoute+"images/placeholder_img_L04.jpg" : golbalIp+data.data.img,
									end_time=data.data.end_time*1000,
									start_time=data.data.start_time*1000,
									now_time=new Date().getTime(),
									state=["未开始","直播中...","已结束"];
									if(start_time>now_time){
										state=state[0]
									}else if(end_time<now_time){
										state=state[2]	
									}else {
										state=state[1]
									}
									
									
								var str="";
									str+='<ul class="live_broadcast_list_detail">';
									str+='	<li class="f_pr f_cf">';
									str+='		<div class="f_full f_pr">';
									str+='			<div class="live_broadcat_img f_pr">';
									str+='				<div class="live_inner_img f_full f_pa">';
									str+='					<img src="'+img+'" width="100%" height="100%" class="f_vat"/>';
									str+='				</div>';
									str+='			</div>';
									str+='			<div class="live_broadcat_info">';
									str+='				<div class="title f_tac"><div class="title_inner">'+data.data.title+'</div></div>';
									str+='				<div class="state f_tac">'+state+'</div>';
									str+='				<div class="des f_tac f_cf">';
									str+='					<div class="des_intro f_pr">'+data.data.mark+'</div>';
									str+='				</div>';
									str+='			</div>';
									str+='		</div>';
									str+='	</li>';
									str+='</ul>';				
									$(".live_broadcast_list_detail_box").html(str);
									
										
								
								//文章列表
								if(data.data.article.list.length>0){
									var str1="";//variable_obj.formatDate(item.created*1000)
										$.each(data.data.article.list,function(i,item){	
											var end_time=data.data.end_time*1000,
												start_time=data.data.start_time*1000,
												now_time=new Date().getTime(),
												state=["未开始","直播中...","已结束"];
												if(start_time>now_time){
													state=state[0]
												}else if(end_time<now_time){
													state=state[2]	
												}else {
													state=state[1]
												}										
											str1+='<li class="f_cf">';
											str1+='	<div class="f_fl time_state f_tac">';
											str1+='		<div class="time f_pr">'+variable_obj.formatDate(item.created*1000)+'</div>';
											str1+='		<div class="state_text">'+state+'</div>';
											str1+='	</div>';
											str1+='	<div class="f_pr comment_name_intro">';
											str1+='		<div class="head_name">';
											str1+='			<div class="head_box f_pr f_dib f_vat"><img src="images/head_sculpture.png" width="100%" class="f_vat"/></div>';
											str1+='			<div class="name f_toe f_dib f_vat jump_personal_info" data-author_id="'+item.author_id+'">'+item.author+' </div>';
											str1+='		</div>';
											str1+='		<div class="slideBox">';
											str1+='			<div class="bd">';
											str1+='				<dl>';
											if($.isArray(item.img)){
												$.each(item.img,function(i,subItem){
													var img=(subItem==null || subItem=="")  ? imgRoute+"images/placeholder_img_L04.jpg" : golbalIp+subItem;
															str1+='<dd><a href="javascript:;" class="f_full f_db f_pa"><img src="'+img+'" /></a></dd>';
												});
											}else {
												var img=(item.img==null || item.img=="")  ? imgRoute+"images/placeholder_img_L04.jpg" : golbalIp+item.img;
												str1+='<dd><a href="javascript:;" class="f_full f_db f_pa"><img src="'+img+'" /></a></dd>';
											}
											str1+='				</dl>';
											str1+='			</div>';
											if($.isArray(item.img)){
												str1+='			<a class="prev" href="javascript:void(0)"></a>';
												str1+='			<a class="next" href="javascript:void(0)"></a>';
											}
											str1+='		</div>';
											if(item.type==3){
												str1+='		<div class="intro"><a href="video_detail.html?id='+item.id+'">'+item.abstract+'</a></div>';
											}else {
												str1+='		<div class="intro"><a href="article_detail.html?id='+item.id+'">'+item.abstract+'</a></div>';
											}
														
											str1+='		<div class="comment_module">';
											str1+='			<dl class="comment_list">';
//											str1+='				<dd class="f_cf">';
//											str1+='					<div class="head f_pr f_fl"><img src="images/head_sculpture.png" width="100%" class="f_vat"/></div>';
//											str1+='					<div class="f_pr name_time_content">';
//											str1+='						<div class="name_time"><div class="f_dib name f_toe f_vat">Jade-Fun</div><div class="f_dib time">8 分钟前</div></div>';
//											str1+='						<div class="content">vivo当然是没闲着。继早前高调推出vivo Xplay6库里定制版之后，vivo也为旗下的热销智能手机vivo X9加推了和NBA独家合作</div>';
//											str1+='					</div>';
//											str1+='				</dd>';
											str1+='			</dl>';
//											str1+='			<div class="view_more_comment"><div class="more_comment f_vat f_dib">查看更多 （12）</div></div>';
											str1+='			<div class="public_comment">';
											str1+='				<form action="" class="f_full f_pr f_cf">';
											str1+='					<label class="for_text" for="comment_des'+item.id+'">| 我有话要说</label>';
											str1+='					<input type="text" class="comment_des placeholder f_fl" id="comment_des'+item.id+'" data-id="'+item.id+'"/>';
											str1+='					<input type="button" class="public_btn f_fr" data-article_id="'+item.id+'" value="发表"/>';
											str1+='				</form>';
											str1+='			</div>';
											str1+='		</div>';
														
											str1+='	</div>';            
											str1+='</li>';	
										});
										$(".live_broadcast_detail_list").find("ul").append(str1);
								}else {
									$(".live_broadcast_detail_list").find("ul").addClass("no_data");
								}


									//请求页码递增
										if(data.data.article.length<root.dataNum || data.data.article.total==pagenum){
											pagenum=pagenum;
											$(".load_more_article").addClass("f_dn")	
										}else {
											skipnum+=pagenum;
											var remain=data.data.article.total>=skipnum ? data.data.article.total-skipnum : 0;
											$(".load_more_article").html("查看更多（"+remain+"）").removeClass("f_dn");
											if(remain==0){$(".load_more_article").addClass("f_dn");}
										}
								
								
								//移除loading的效果
								$(".main_content[data-type='live_broadcast_list_detail']").removeClass("loading");
								
								
							}else {
								
							}
						},
						error:function(){
							alert("网络错误，请稍后再试！");
							load_data_lock=false;
						}	
					});
				
				
				//加载更多文章
				var moreDataLock=false;
				$(".load_more_article").on("click",function(){
					if(!moreDataLock){
						moreDataLock=true;
						$.ajax({
							url:golbalIp+"/main/live_detail",
							type:"get",
							dataType:"json",
							data:{"skipnum":skipnum,"length":pagenum,"id":units.getUrlParam("id")!=null ? units.getUrlParam("id") : ""},
							beforeSend:function(){},
							success:function(data){
								//请求成功
								if(data.code==1){

	
									if(data.data.article.list.length>0){
										var str1="";//variable_obj.formatDate(item.created*1000)
											$.each(data.data.article.list,function(i,item){	
												var end_time=data.data.end_time*1000,
													start_time=data.data.start_time*1000,
													now_time=new Date().getTime(),
													state=["未开始","直播中...","已结束"];
													if(start_time>now_time){
														state=state[0]
													}else if(end_time<now_time){
														state=state[2]	
													}else {
														state=state[1]
													}	
												str1+='<li class="f_cf">';
												str1+='	<div class="f_fl time_state f_tac">';
												str1+='		<div class="time f_pr">'+variable_obj.formatDate(item.created*1000)+'</div>';
												str1+='		<div class="state_text">'+state+'</div>';
												str1+='	</div>';
												str1+='	<div class="f_pr comment_name_intro">';
												str1+='		<div class="head_name">';
												str1+='			<div class="head_box f_pr f_dib f_vat"><img src="images/head_sculpture.png" width="100%" class="f_vat"/></div>';
												str1+='			<div class="name f_toe f_dib f_vat jump_personal_info" data-author_id="'+item.author_id+'">'+item.author+' </div>';
												str1+='		</div>';
												str1+='		<div class="slideBox">';
												str1+='			<div class="bd">';
												str1+='				<dl>';
												if($.isArray(item.img)){
													$.each(item.img,function(i,subItem){
														var img=(subItem==null || subItem=="")  ? imgRoute+"images/placeholder_img_L04.jpg" : golbalIp+subItem;
																str1+='<dd><a href="javascript:;" class="f_full f_db f_pa"><img src="'+img+'" /></a></dd>';
													});
												}else {
													var img=(item.img==null || item.img=="")  ? imgRoute+"images/placeholder_img_L04.jpg" : golbalIp+item.img;
													str1+='<dd><a href="javascript:;" class="f_full f_db f_pa"><img src="'+img+'" /></a></dd>';
												}
												str1+='				</dl>';
												str1+='			</div>';
												if($.isArray(item.img)){
													str1+='			<a class="prev" href="javascript:void(0)"></a>';
													str1+='			<a class="next" href="javascript:void(0)"></a>';
												}
												str1+='		</div>';
												if(item.type==3){
													str1+='		<div class="intro"><a href="video_detail.html?id='+item.id+'">'+item.abstract+'</a></div>';
												}else {
													str1+='		<div class="intro"><a href="article_detail.html?id='+item.id+'">'+item.abstract+'</a></div>';
												}
															
												str1+='		<div class="comment_module">';
												str1+='			<dl class="comment_list">';
	//											str1+='				<dd class="f_cf">';
	//											str1+='					<div class="head f_pr f_fl"><img src="images/head_sculpture.png" width="100%" class="f_vat"/></div>';
	//											str1+='					<div class="f_pr name_time_content">';
	//											str1+='						<div class="name_time"><div class="f_dib name f_toe f_vat">Jade-Fun</div><div class="f_dib time">8 分钟前</div></div>';
	//											str1+='						<div class="content">vivo当然是没闲着。继早前高调推出vivo Xplay6库里定制版之后，vivo也为旗下的热销智能手机vivo X9加推了和NBA独家合作</div>';
	//											str1+='					</div>';
	//											str1+='				</dd>';
												str1+='			</dl>';
	//											str1+='			<div class="view_more_comment"><div class="more_comment f_vat f_dib">查看更多 （12）</div></div>';
												str1+='			<div class="public_comment">';
												str1+='				<form action="" class="f_full f_pr f_cf">';
												str1+='					<label class="for_text" for="comment_des">| 我有话要说</label>';
												str1+='					<input type="text" class="comment_des placeholder f_fl" id="comment_des" data-id="'+item.id+'"/>';
												str1+='					<input type="button" class="public_btn f_fr" data-article_id="'+item.id+'" value="发表"/>';
												str1+='				</form>';
												str1+='			</div>';
												str1+='		</div>';
															
												str1+='	</div>';            
												str1+='</li>';	
											});
											$(".live_broadcast_detail_list").find("ul").append(str1);
									}else {
										//没有更多数据
										$(".load_more_article").addClass("f_dn");
									}
									
									//请求页码递增
										if(data.data.article.length<root.dataNum || data.data.article.total==pagenum){
											pagenum=pagenum;
											$(".load_more_article").addClass("f_dn");
										}else {
											skipnum+=pagenum;
											var remain=data.data.article.total>=skipnum ? data.data.article.total-skipnum : 0;
											$(".load_more_article").html("查看更多（"+remain+"）").removeClass("f_dn");
											if(remain==0){$(".load_more_article").addClass("f_dn");}
										}
										
									
									moreDataLock=false;
									
								}else {
									
								}
								
							},
							error:function(){
								alert("网络错误，请稍后再试！");
								load_data_lock=false;
							}	
						});
					}
				});
				

				
				//轮播图插件初始化
				$(".slideBox").slide({ mainCell:".bd dl", effect:"fade",autoPlay:true/*,trigger:"",easing:ary[4],delayTime:ary[5],mouseOverStop:ary[6],*/,pnLoop:false });
			
			
			

				//发表评论
				root.public_lock=false;	
				$(".live_broadcast_detail_list").on("click",function(e){
					var target=$(e.target);
						if(target.hasClass("public_btn")){
							if($.cookie('bz')===undefined || $.trim($.cookie('bz'))==="" || ((new Date().getTime()/1000-JSON.parse($.cookie('bz')).updated) > 3600)){
								alert("您未登录或者登录超时，请重新登录后操作！");
								return false;	
							}else {
								var val=$.trim(target.prev(".comment_des").val()),article_id=target.attr("data-article_id");
																	
								if(!root.public_lock){
									root.public_lock=!0;
									
									//获取个人资料
									$.ajax({
										url:golbalIp+"/user/info",
										type:"get",
										dataType:"json",
										data:{"account":JSON.parse($.cookie('bz')).account,"token":JSON.parse($.cookie('bz')).token},
										beforeSend:function(){},
										success:function(info){
											if(info.code==1){
											
												//请求成功
												var img=( info.data.img==null ||  info.data.img=="")  ? imgRoute+"images/head_sculpture.png" : golbalIp+ info.data.img;
													$.ajax({
														url:golbalIp+"/user/create_comment",
														type:"post",
														dataType:"json",
														data:{"content":val,"id":article_id,"account":JSON.parse($.cookie('bz')).account,"token":JSON.parse($.cookie('bz')).token},
														beforeSend:function(){},
														success:function(data){
															if(data.code==1){
																var list_box=target.parents(".comment_module").find(".comment_list"),
																	html='<dd class="f_cf">';
																	html+='<div class="head f_pr f_fl"><img src="'+img+'" width="100%" class="f_vat"/></div>';
																	html+='<div class="f_pr name_time_content">';
																	html+='<div class="name_time">';
																	html+='<div class="f_dib name f_toe f_vat  jump_personal_info" data-author_id="'+info.data.id+'">'+info.data.nickname+'</div>';
																	html+='<div class="f_dib time">刚刚</div></div>';
																	html+='<div class="content">'+val+'</div>';
																	html+='</div>';
																	html+='</dd>';
																	list_box.prepend(html);
																	target.removeClass("active").prev(".comment_des").val("").prev(".for_text").show();
															}else {
																alert(data.message);	
															}
															root.public_lock=!1;
														},error:function(){alert("网络异常，请稍后重试！");root.public_lock=!1;
														}
													});
										
											}else if(info.code==3){//未登录
												alert("登录超时，请重新登录！");	
											}else {
												alert(data.message);
											}
											root.public_lock=!1;
										},
										error:function(){
											alert("网络错误，请稍后再试！");
											root.public_lock=!1;
										}		
									})	
								}
							}
						}
				});
			
			
			})
        </script>
        
    </body>
    
</html>